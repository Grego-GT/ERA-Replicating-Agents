<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ERA - AI Agent Creator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        font-family: 'Courier New', monospace;
        color-scheme: dark;
        background-color: #0a0a0a;
      }

      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      #root {
        width: 100%;
        height: 100vh;
        display: flex;
        flex-wrap: nowrap; /* Prevent wrapping */
        background: #0a0a0a;
        color: #f0f0f0;
        position: relative;
      }

      #sidebar {
        width: 280px;
        min-width: 280px; /* Ensure it doesn't shrink */
        max-width: 280px; /* Ensure it doesn't grow */
        background: #1a1a1a;
        border-right: 1px solid #333;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        flex-shrink: 0; /* Prevent flex from shrinking it */
        z-index: 1000; /* Ensure it stays on top */
        transition: transform 0.3s ease;
      }

      /* Mobile: Sidebar becomes overlay */
      @media (max-width: 768px) {
        #sidebar {
          position: fixed;
          left: 0;
          top: 0;
          height: 100vh;
          transform: translateX(-100%);
          box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
        }

        #sidebar.open {
          transform: translateX(0);
        }

        #main-content {
          margin-left: 0 !important;
        }
      }

      /* Sidebar toggle button for mobile */
      #sidebar-toggle {
        display: none;
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 999;
        background: #50fa7b;
        border: none;
        border-radius: 8px;
        padding: 10px 14px;
        cursor: pointer;
        font-size: 20px;
        box-shadow: 0 2px 10px rgba(80, 250, 123, 0.3);
        transition: all 0.3s ease;
      }

      #sidebar-toggle:hover {
        background: #6cffb1;
        box-shadow: 0 4px 15px rgba(80, 250, 123, 0.5);
        transform: scale(1.05);
      }

      #sidebar-toggle:active {
        transform: scale(0.95);
      }

      @media (max-width: 768px) {
        #sidebar-toggle {
          display: block;
        }
      }

      /* Overlay backdrop for mobile */
      #sidebar-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      @media (max-width: 768px) {
        #sidebar-backdrop.show {
          display: block;
        }
      }

      #sidebar-header {
        padding: 16px;
        border-bottom: 1px solid #333;
        background: #151515;
      }

      #sidebar-title {
        font-weight: bold;
        color: #50fa7b;
        margin-bottom: 8px;
        font-size: 14px;
      }

      #current-path {
        font-size: 11px;
        color: #888;
        word-break: break-all;
      }

      #file-explorer {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
      }

      .file-item, .folder-item {
        padding: 8px 12px;
        margin: 2px 0;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .file-item:hover, .folder-item:hover {
        background: #2a2a2a;
      }

      .folder-item {
        color: #8be9fd;
        font-weight: 500;
      }

      .file-item {
        color: #f0f0f0;
      }

      .file-icon, .folder-icon {
        flex-shrink: 0;
      }

      #main-content {
        flex: 1;
        min-width: 0; /* Allow flexbox to shrink below content size */
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden; /* Prevent overflow from breaking layout */
      }

      #terminal {
        flex: 1;
        background: #0a0a0a;
        padding: 20px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
        white-space: pre-wrap;
        word-wrap: break-word;
        user-select: text;
        cursor: text;
      }

      #terminal:focus {
        outline: none;
      }

      #terminal::selection {
        background: rgba(255, 255, 255, 0.2);
        color: inherit;
      }

      #input-container {
        padding: 16px 20px;
        background: #0f0f0f;
        border-top: 2px solid #50fa7b;
        display: flex;
        align-items: center;
        box-shadow: 0 -4px 20px rgba(80, 250, 123, 0.1);
      }

      #prompt {
        color: #50fa7b;
        margin-right: 8px;
        user-select: none;
        font-weight: bold;
        font-size: 16px;
      }

      #user-input {
        flex: 1;
        background: transparent;
        border: none;
        outline: none;
        color: #f0f0f0;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        padding: 4px 8px;
        position: relative;
        caret-color: #50fa7b;
      }

      #user-input:focus {
        background: rgba(80, 250, 123, 0.08);
        border-radius: 3px;
      }

      /* Custom blinking cursor effect */
      #input-container::after {
        content: '▋';
        color: #50fa7b;
        font-size: 16px;
        margin-left: -18px;
        animation: blink-cursor 1s step-end infinite;
        pointer-events: none;
      }

      #input-container.typing::after {
        display: none;
      }

      @keyframes blink-cursor {
        0%, 49% { opacity: 1; }
        50%, 100% { opacity: 0; }
      }

      .status-indicator {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        background: #1a1a1a;
        padding: 8px 16px;
        border-radius: 8px;
        border: 1px solid #333;
        z-index: 1000;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #50fa7b;
      }

      .status-dot.connecting {
        background: #f1fa8c;
        animation: pulse 1s infinite;
      }

      .status-dot.disconnected {
        background: #ff5555;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      .user-count {
        position: absolute;
        top: 20px;
        right: 180px;
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(80, 250, 123, 0.1);
        padding: 8px 16px;
        border-radius: 8px;
        border: 1px solid #50fa7b;
        z-index: 998;
        font-size: 13px;
        color: #50fa7b;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .user-count.updated {
        background: rgba(80, 250, 123, 0.2);
        box-shadow: 0 0 20px rgba(80, 250, 123, 0.3);
        transform: scale(1.05);
      }

      .user-count-icon {
        font-size: 16px;
        animation: pulse-icon 2s ease-in-out infinite;
      }

      @keyframes pulse-icon {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }

      /* Mobile responsive adjustments */
      @media (max-width: 768px) {
        .user-count {
          top: 80px;
          right: 10px;
          left: auto;
          font-size: 11px;
          padding: 6px 10px;
        }

        .status-indicator {
          top: 20px;
          right: 10px;
          font-size: 11px;
          padding: 6px 10px;
        }

        .user-count-icon {
          font-size: 14px;
        }

        .status-dot {
          width: 6px;
          height: 6px;
        }

        #keyboard-hint {
          font-size: 10px;
          padding: 6px 8px;
        }

        #terminal {
          padding: 10px;
          font-size: 12px;
        }

        #input-container {
          padding: 10px;
        }

        #user-input {
          font-size: 12px;
        }

        #prompt {
          font-size: 14px;
        }
      }

      #refresh-files {
        padding: 6px 12px;
        background: #2a2a2a;
        border: 1px solid #444;
        border-radius: 4px;
        color: #f0f0f0;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 8px;
      }

      #refresh-files:hover {
        background: #333;
        border-color: #555;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #888;
        font-size: 12px;
      }

      #keyboard-hint {
        position: absolute;
        bottom: 90px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(26, 26, 26, 0.9);
        border: 1px solid #333;
        border-radius: 6px;
        padding: 8px 16px;
        font-size: 11px;
        color: #888;
        pointer-events: auto;
        backdrop-filter: blur(4px);
        cursor: pointer;
        transition: opacity 0.2s;
      }

      #keyboard-hint:hover {
        background: rgba(26, 26, 26, 0.95);
        border-color: #444;
      }

      #keyboard-hint.hidden {
        opacity: 0;
        pointer-events: none;
      }

      #copy-indicator {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(80, 250, 123, 0.9);
        color: #0a0a0a;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: bold;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
      }

      #copy-indicator.show {
        opacity: 1;
      }

      /* ag-ui Preview Button */
      #ag-ui-button {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
        color: #0a0a0a;
        border: none;
        border-radius: 6px;
        padding: 8px 14px;
        font-weight: 600;
        font-size: 11px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(56, 189, 248, 0.4);
        transition: all 0.2s;
        z-index: 100;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      #ag-ui-button:hover {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(56, 189, 248, 0.5);
      }

      #ag-ui-button:active {
        transform: translateY(0);
      }

      /* ag-ui Modal */
      #ag-ui-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        backdrop-filter: blur(4px);
      }

      #ag-ui-modal-content {
        position: relative;
        width: 90%;
        max-width: 1200px;
        height: 90%;
        margin: 2.5% auto;
        background: #0f172a;
        border-radius: 16px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        display: flex;
        flex-direction: column;
      }

      #ag-ui-modal-header {
        padding: 20px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.15);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      #ag-ui-modal-header h3 {
        margin: 0;
        color: #38bdf8;
        font-size: 20px;
      }

      #ag-ui-close {
        background: none;
        border: none;
        color: #94a3b8;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        border-radius: 4px;
        transition: all 0.2s;
      }

      #ag-ui-close:hover {
        background: rgba(148, 163, 184, 0.15);
        color: #f8fafc;
      }

      #ag-ui-container {
        flex: 1;
        overflow: auto;
        padding: 24px;
      }

      /* Mobile responsiveness for ag-ui */
      @media (max-width: 768px) {
        #ag-ui-button {
          bottom: 16px;
          right: 16px;
          font-size: 10px;
          padding: 6px 10px;
        }

        #keyboard-hint {
          bottom: 70px;
          font-size: 10px;
          padding: 6px 12px;
        }

        #ag-ui-modal-content {
          width: 95%;
          height: 95%;
          margin: 2.5% auto;
        }

        #ag-ui-modal-header {
          padding: 16px;
        }

        #ag-ui-modal-header h3 {
          font-size: 16px;
        }

        #ag-ui-container {
          padding: 16px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar toggle button (mobile only) -->
    <button id="sidebar-toggle" aria-label="Toggle sidebar">☰</button>

    <!-- Sidebar backdrop (mobile only) -->
    <div id="sidebar-backdrop"></div>

    <div id="root">
      <!-- Sidebar File Explorer -->
      <div id="sidebar">
        <div id="sidebar-header">
          <div id="sidebar-title">📁 File Explorer</div>
          <div id="current-path">/Users/binsquare/Documents/AgFactory</div>
          <button id="refresh-files">🔄 Refresh</button>
        </div>
        <div id="file-explorer">
          <div class="loading">Loading files...</div>
        </div>
      </div>

      <!-- Main Terminal Content -->
      <div id="main-content">
        <div id="terminal" tabindex="-1"></div>
        
        <div id="input-container">
          <span id="prompt">$</span>
          <input type="text" id="user-input" autofocus autocomplete="off" spellcheck="false" />
        </div>

        <div class="user-count">
          <span class="user-count-icon">👥</span>
          <span id="user-count-text">0 online</span>
        </div>

        <div class="status-indicator">
          <div class="status-dot" id="status-dot"></div>
          <span id="status-text">Connecting...</span>
        </div>

        <div id="keyboard-hint" title="Click to hide">
          💡 Commands: cli, cd, ls, cat, pwd, deno, clear | Ctrl+C to interrupt | Select text to copy
        </div>

        <!-- ag-ui Preview Button -->
        <button id="ag-ui-button" title="View agent state and tool calls">
          <span>🔍</span>
          <span>AG-UI</span>
        </button>
      </div>
    </div>

    <!-- Copy indicator -->
    <div id="copy-indicator">✓ Copied to clipboard!</div>

    <!-- ag-ui Modal -->
    <div id="ag-ui-modal">
      <div id="ag-ui-modal-content">
        <div id="ag-ui-modal-header">
          <h3>Agent State & Tool Calls</h3>
          <button id="ag-ui-close">&times;</button>
        </div>
        <div id="ag-ui-container"></div>
      </div>
    </div>

    <script>
      const terminal = document.getElementById('terminal');
      const userInput = document.getElementById('user-input');
      const statusDot = document.getElementById('status-dot');
      const statusText = document.getElementById('status-text');
      const fileExplorer = document.getElementById('file-explorer');
      const currentPathEl = document.getElementById('current-path');
      const refreshBtn = document.getElementById('refresh-files');
      const copyIndicator = document.getElementById('copy-indicator');
      const userCountText = document.getElementById('user-count-text');
      const userCountEl = document.querySelector('.user-count');
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebar-toggle');
      const sidebarBackdrop = document.getElementById('sidebar-backdrop');
      const keyboardHint = document.getElementById('keyboard-hint');
      
      let ws = null;
      let currentPath = '..';
      let currentRelativePath = '..';
      let heartbeatInterval = null;
      let reconnectAttempts = 0;
      const MAX_RECONNECT_ATTEMPTS = 5;
      let connectionStableTimeout = null;
      let isConnecting = false;

      // ANSI color map
      const ansiColors = {
        '30': '#000000', '31': '#ff5555', '32': '#50fa7b', '33': '#f1fa8c',
        '34': '#bd93f9', '35': '#ff79c6', '36': '#8be9fd', '37': '#f8f8f2',
        '90': '#6272a4', '91': '#ff6e6e', '92': '#69ff94', '93': '#ffffa5',
        '94': '#d6acff', '95': '#ff92df', '96': '#a4ffff', '97': '#ffffff',
      };

      function parseAnsi(text) {
        // Remove cursor positioning and screen clearing codes
        text = text.replace(/\x1b\[\d+;\d+H/g, ''); // Cursor position
        text = text.replace(/\x1b\[\d*J/g, '');     // Clear screen
        text = text.replace(/\x1b\[\d*K/g, '');     // Clear line
        
        // Parse color codes
        const parts = text.split(/(\x1b\[\d*m)/g);
        let html = '';
        let currentColor = '#f0f0f0';
        let isBold = false;
        
        for (let i = 0; i < parts.length; i++) {
          const part = parts[i];
          
          // Check if this is an ANSI code
          const match = part.match(/\x1b\[(\d*)m/);
          if (match) {
            const code = match[1];
            
            if (code === '0' || code === '') {
              // Reset
              currentColor = '#f0f0f0';
              isBold = false;
            } else if (code === '1') {
              // Bold
              isBold = true;
            } else if (ansiColors[code]) {
              // Color
              currentColor = ansiColors[code];
            }
          } else if (part) {
            // Regular text
            const style = `color: ${currentColor};${isBold ? ' font-weight: bold;' : ''}`;
            html += `<span style="${style}">${escapeHtml(part)}</span>`;
          }
        }
        
        return html;
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function write(text) {
        // Parse ANSI codes and append as HTML
        const html = parseAnsi(text);
        const span = document.createElement('span');
        span.innerHTML = html;
        terminal.appendChild(span);
        terminal.scrollTop = terminal.scrollHeight;
      }

      function writeLine(text, color = '#f0f0f0') {
        const span = document.createElement('span');
        span.style.color = color;
        span.textContent = text + '\n';
        terminal.appendChild(span);
        terminal.scrollTop = terminal.scrollHeight;
      }

      function writeHTML(html) {
        const span = document.createElement('span');
        span.innerHTML = html + '\n';
        terminal.appendChild(span);
        terminal.scrollTop = terminal.scrollHeight;
      }

      function setStatus(status) {
        statusDot.className = 'status-dot ' + status;
        if (status === 'connected') {
          statusText.textContent = 'Connected';
        } else if (status === 'connecting') {
          statusText.textContent = 'Connecting...';
        } else {
          statusText.textContent = 'Disconnected';
        }
      }

      // File Explorer Functions
      async function loadFiles(relativePath = '..') {
        try {
          console.log('📂 Loading files from relative path:', relativePath);
          fileExplorer.innerHTML = '<div class="loading">Loading files...</div>';
          const response = await fetch(`/api/files?path=${encodeURIComponent(relativePath)}`);
          const data = await response.json();
          console.log('📂 Received data:', data);
          
          if (data.error) {
            fileExplorer.innerHTML = `<div class="loading" style="color: #ff5555;">Error: ${data.error}</div>`;
            return;
          }

          // Store both absolute (for display) and relative (for API calls)
          currentPath = data.path;
          currentRelativePath = relativePath;
          currentPathEl.textContent = data.path;
          renderFileTree(data.entries);
        } catch (error) {
          console.error('Failed to load files:', error);
          fileExplorer.innerHTML = '<div class="loading" style="color: #ff5555;">Failed to load files</div>';
        }
      }

      function getFileIcon(name, isDirectory) {
        if (isDirectory) return '📁';
        if (name.endsWith('.ts') || name.endsWith('.tsx')) return '📘';
        if (name.endsWith('.js') || name.endsWith('.jsx')) return '📙';
        if (name.endsWith('.json')) return '📋';
        if (name.endsWith('.md')) return '📝';
        if (name.endsWith('.html')) return '🌐';
        if (name.endsWith('.css')) return '🎨';
        return '📄';
      }

      function renderFileTree(entries) {
        fileExplorer.innerHTML = '';

        // Sort: directories first, then files
        const sorted = entries.sort((a, b) => {
          if (a.isDirectory && !b.isDirectory) return -1;
          if (!a.isDirectory && b.isDirectory) return 1;
          return a.name.localeCompare(b.name);
        });

        sorted.forEach(entry => {
          const item = document.createElement('div');
          const icon = getFileIcon(entry.name, entry.isDirectory);
          
          if (entry.isDirectory) {
            item.className = 'folder-item';
            item.innerHTML = `<span class="folder-icon">${icon}</span><span>${entry.name}/</span>`;
            item.onclick = () => loadFiles(entry.path);
          } else {
            item.className = 'file-item';
            item.innerHTML = `<span class="file-icon">${icon}</span><span>${entry.name}</span>`;
            item.onclick = () => viewFile(entry.path);
          }
          
          fileExplorer.appendChild(item);
        });

        // Add parent directory link if not at root
        if (currentRelativePath !== '..') {
          const parentItem = document.createElement('div');
          parentItem.className = 'folder-item';
          parentItem.innerHTML = '<span class="folder-icon">⬆️</span><span>..</span>';
          parentItem.onclick = () => {
            // Go up one level from current relative path
            const pathParts = currentRelativePath.split('/');
            const parentPath = pathParts.length > 1 
              ? pathParts.slice(0, -1).join('/') || '..'
              : '..';
            loadFiles(parentPath);
          };
          fileExplorer.insertBefore(parentItem, fileExplorer.firstChild);
        }
      }

      function viewFile(path) {
        writeLine('', '#888');
        writeLine(`📄 Viewing: ${path}`, '#8be9fd');
        writeLine('─'.repeat(60), '#444');
        
        fetch(`/api/file-content?path=${encodeURIComponent(path)}`)
          .then(res => res.json())
          .then(data => {
            if (data.error) {
              writeLine(`Error: ${data.error}`, '#ff5555');
            } else {
              const lines = data.content.split('\n').slice(0, 50); // First 50 lines
              lines.forEach(line => writeLine(line));
              if (data.content.split('\n').length > 50) {
                writeLine('...', '#888');
                writeLine(`(showing first 50 lines of ${data.content.split('\n').length})`, '#888');
              }
            }
            writeLine('─'.repeat(60), '#444');
            writeLine('');
          })
          .catch(error => {
            writeLine(`Error loading file: ${error.message}`, '#ff5555');
          });
      }

      // WebSocket Connection
      function connectWebSocket() {
        if (isConnecting) {
          console.log('⚠️ Already connecting, skipping...');
          return;
        }

        isConnecting = true;
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws`;
        
        console.log('🔌 Connecting to:', wsUrl);
        setStatus('connecting');

        // Clear any existing heartbeat
        if (heartbeatInterval) {
          clearInterval(heartbeatInterval);
          heartbeatInterval = null;
        }

        // Clear connection stability timeout
        if (connectionStableTimeout) {
          clearTimeout(connectionStableTimeout);
          connectionStableTimeout = null;
        }

        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          console.log('✅ WebSocket connected');
          setStatus('connected');
          isConnecting = false;
          
          // Mark connection as stable after 5 seconds
          connectionStableTimeout = setTimeout(() => {
            reconnectAttempts = 0; // Reset reconnect counter only after stable
            console.log('✅ Connection stable');
          }, 5000);
          
          writeHTML('<span style="color: #50fa7b;">╔════════════════════════════════════════════════════════════════╗</span>');
          writeHTML('<span style="color: #50fa7b;">║              🏭  ERA Web Terminal                              ║</span>');
          writeHTML('<span style="color: #50fa7b;">║              Emergent Replicating Agents - v1.0.0              ║</span>');
          writeHTML('<span style="color: #50fa7b;">╚════════════════════════════════════════════════════════════════╝</span>');
          writeLine('');
          writeLine('✅ Connected! Starting ERA CLI...', '#8be9fd');
          writeLine('💡 Type your response and press Enter. Use Ctrl+C to interrupt.', '#888');
          writeLine('');

          // Start heartbeat to keep connection alive
          heartbeatInterval = setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
              try {
                ws.send(JSON.stringify({ type: 'ping' }));
                console.log('💓 Heartbeat sent');
              } catch (error) {
                console.error('❌ Heartbeat failed:', error);
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
              }
            } else {
              console.warn('⚠️ WebSocket not open, clearing heartbeat');
              clearInterval(heartbeatInterval);
              heartbeatInterval = null;
            }
          }, 10000); // Every 10 seconds (Fly.io timeout is ~20s)

          // Start the CLI after a small delay to ensure connection is established
          setTimeout(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify({ type: 'start_cli' }));
            }
          }, 100);
        };

        ws.onmessage = (event) => {
          try {
            const message = JSON.parse(event.data);
            
            if (message.type === 'output') {
              // Write output directly
              write(message.data);
            } else if (message.type === 'process_exit' || message.type === 'exit') {
              // Process exited but socket stays alive!
              writeLine('');
              if (message.code !== 0) {
                writeLine(`⚠️  Process exited with code: ${message.code}`, '#f1fa8c');
              }
              writeLine('💡 Type a command: cli, cd agents, ls, deno run agents/<name>/index.ts', '#8be9fd');
              writeLine('');
              // Refresh file list when process exits
              loadFiles(currentRelativePath);
            } else if (message.type === 'clear') {
              // Clear terminal
              terminal.innerHTML = '';
            } else if (message.type === 'error') {
              writeLine('');
              writeLine(`❌ Error: ${message.message}`, '#ff5555');
            } else if (message.type === 'connected') {
              console.log('✅ Server confirmed connection');
            } else if (message.type === 'user_count') {
              // Update user count display
              const count = message.count;
              const plural = count === 1 ? 'user' : 'users';
              const oldCount = userCountText.textContent;
              userCountText.textContent = `${count} ${plural} online`;
              
              // Add pulse effect if count changed
              if (oldCount !== userCountText.textContent) {
                userCountEl.classList.add('updated');
                setTimeout(() => {
                  userCountEl.classList.remove('updated');
                }, 500);
              }
              
              console.log(`👥 Received user_count: ${count} ${plural} online`);
            } else if (message.type === 'pong') {
              // Heartbeat response received
              console.log('💓 Heartbeat acknowledged');
            } else {
              console.log('📨 Unknown message type:', message.type, message);
            }
          } catch (error) {
            console.error('Error parsing message:', error);
          }
        };

        ws.onerror = (error) => {
          console.error('❌ WebSocket error:', error);
          console.log('Error details - readyState:', ws?.readyState, 'time:', new Date().toISOString());
          setStatus('disconnected');
          isConnecting = false;
        };

        ws.onclose = (event) => {
          console.log('🔌 WebSocket closed');
          console.log('   Code:', event.code);
          console.log('   Reason:', event.reason || 'No reason provided');
          console.log('   Clean:', event.wasClean);
          console.log('   Time:', new Date().toISOString());
          console.log('   Reconnect attempts:', reconnectAttempts);
          setStatus('disconnected');
          isConnecting = false;
          
          // Clear heartbeat
          if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
          }

          // Clear connection stability timeout
          if (connectionStableTimeout) {
            clearTimeout(connectionStableTimeout);
            connectionStableTimeout = null;
          }

          // Don't auto-reconnect if:
          // 1. Normal closure (code 1000)
          // 2. Max attempts exceeded
          // 3. Connection wasn't stable (closed within 5 seconds)
          const wasUnstable = reconnectAttempts > 0 && event.code !== 1000;
          
          if (event.code === 1000) {
            // Normal closure - don't reconnect
            writeLine('');
            writeLine('⚠️  Connection closed normally', '#f1fa8c');
            writeLine('💡 Refresh to reconnect', '#8be9fd');
          } else if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
            // Max attempts exceeded
            writeLine('');
            writeLine('❌ Connection lost after multiple attempts', '#ff5555');
            writeLine('💡 Please refresh the page to reconnect', '#8be9fd');
            reconnectAttempts = 0; // Reset for next manual reconnect
          } else {
            // Attempt reconnect
            reconnectAttempts++;
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts - 1), 30000); // Exponential backoff, max 30s
            
            writeLine('');
            writeLine(`⚠️  Connection lost (attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`, '#f1fa8c');
            writeLine(`💡 Reconnecting in ${Math.round(delay/1000)}s...`, '#8be9fd');
            
            console.log(`🔄 Reconnecting in ${delay}ms... (attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
            setTimeout(() => {
              console.log('🔄 Attempting reconnect...');
              connectWebSocket();
            }, delay);
          }
        };
      }

      // Add copy detection to show indicator
      document.addEventListener('copy', (e) => {
        const selection = window.getSelection();
        if (selection && selection.toString().length > 0) {
          showCopyIndicator();
        }
      });

      function showCopyIndicator() {
        copyIndicator.classList.add('show');
        setTimeout(() => {
          copyIndicator.classList.remove('show');
        }, 1500);
      }

      // Add paste support
      userInput.addEventListener('paste', (e) => {
        // Let the default paste behavior work, but log it
        console.log('📋 Pasted text into input');
      });

      // Show/hide cursor based on typing
      const inputContainer = document.getElementById('input-container');
      
      userInput.addEventListener('input', () => {
        if (userInput.value.length > 0) {
          inputContainer.classList.add('typing');
        } else {
          inputContainer.classList.remove('typing');
        }
      });

      // Handle input - only send on Enter, but handle Ctrl+C and Ctrl+D immediately
      userInput.addEventListener('keydown', (e) => {
        if (!ws || ws.readyState !== WebSocket.OPEN) return;

        // Special keys that bypass normal input
        if (e.key === 'c' && e.ctrlKey) {
          // Ctrl+C - Send interrupt signal immediately
          e.preventDefault();
          ws.send(JSON.stringify({ type: 'input', data: '\x03' }));
          console.log('📤 Sent Ctrl+C (interrupt)');
          // Clear the input field
          userInput.value = '';
        } else if (e.key === 'd' && e.ctrlKey) {
          // Ctrl+D - Send EOF immediately
          e.preventDefault();
          ws.send(JSON.stringify({ type: 'input', data: '\x04' }));
          console.log('📤 Sent Ctrl+D (EOF)');
          // Clear the input field
          userInput.value = '';
        } else if (e.key === 'Enter') {
          // Enter - Send the whole line
          e.preventDefault();
          const input = userInput.value.trim();
          userInput.value = '';
          
          // Echo what was typed (even if empty for visual feedback)
          if (input) {
            writeLine('$ ' + input, '#bd93f9');
          }
          
          // Always send to process (including empty lines for "skip" scenarios)
          if (ws.readyState === WebSocket.OPEN) {
            // Try to detect if it's a new command vs process input
            // For simplicity, we'll send as command if it starts with known commands
            const isCommand = input && (
              input.startsWith('cli') || 
              input.startsWith('deno') || 
              input.startsWith('ls') || 
              input.startsWith('cat') ||
              input.startsWith('pwd') ||
              input.startsWith('cd') ||
              input === 'clear'
            );
            
            if (isCommand) {
              // Run as new command
              ws.send(JSON.stringify({ type: 'run_command', command: input }));
              console.log('📤 Sent command:', input);
            } else {
              // Send as input to running process (including empty lines)
              ws.send(JSON.stringify({ type: 'input', data: input + '\n' }));
              console.log('📤 Sent input:', input || '(empty line)');
            }
          }
          
          // Remove typing class after sending
          inputContainer.classList.remove('typing');
        }
        // All other keys are handled normally by the input field
      });

      // Keep input focused (but not when selecting text in terminal)
      userInput.focus();
      
      let isSelecting = false;
      terminal.addEventListener('mousedown', () => {
        isSelecting = true;
      });
      
      document.addEventListener('mouseup', () => {
        // If we were selecting and there's a selection, don't refocus
        const selection = window.getSelection();
        if (isSelecting && selection && selection.toString().length > 0) {
          console.log('📋 Text selected, maintaining selection');
        } else {
          // Otherwise refocus the input
          setTimeout(() => {
            if (!document.activeElement || document.activeElement === document.body) {
              userInput.focus();
            }
          }, 10);
        }
        isSelecting = false;
      });

      document.addEventListener('click', (e) => {
        // Don't steal focus when clicking sidebar, buttons, or selecting text
        if (!e.target.closest('#sidebar') && 
            e.target.tagName !== 'BUTTON' &&
            e.target !== terminal) {
          userInput.focus();
        }
      });

      // Refresh button
      refreshBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('🔄 Refresh clicked, relative path:', currentRelativePath);
        loadFiles(currentRelativePath);
      });

      // Mobile sidebar toggle
      function toggleSidebar() {
        const isOpen = sidebar.classList.contains('open');
        if (isOpen) {
          sidebar.classList.remove('open');
          sidebarBackdrop.classList.remove('show');
        } else {
          sidebar.classList.add('open');
          sidebarBackdrop.classList.add('show');
        }
      }

      sidebarToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleSidebar();
      });

      // Close sidebar when clicking backdrop
      sidebarBackdrop.addEventListener('click', () => {
        toggleSidebar();
      });

      // Close sidebar when clicking inside (after selecting a file/folder on mobile)
      sidebar.addEventListener('click', (e) => {
        // Only close on mobile
        if (window.innerWidth <= 768) {
          // Close after a short delay to allow the action to complete
          setTimeout(() => {
            if (sidebar.classList.contains('open')) {
              toggleSidebar();
            }
          }, 300);
        }
      });

      // Keyboard hint toggle
      keyboardHint.addEventListener('click', () => {
        keyboardHint.classList.toggle('hidden');
      });

      // ag-ui Modal Controls
      const agUiModal = document.getElementById('ag-ui-modal');
      const agUiButton = document.getElementById('ag-ui-button');
      const agUiClose = document.getElementById('ag-ui-close');
      const agUiContainer = document.getElementById('ag-ui-container');
      let agUiInitialized = false;

      agUiButton.addEventListener('click', () => {
        agUiModal.style.display = 'block';
        if (!agUiInitialized) {
          initializeAgUi();
          agUiInitialized = true;
        }
      });

      agUiClose.addEventListener('click', () => {
        agUiModal.style.display = 'none';
      });

      // Close on outside click
      agUiModal.addEventListener('click', (e) => {
        if (e.target === agUiModal) {
          agUiModal.style.display = 'none';
        }
      });

      // Close on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && agUiModal.style.display === 'block') {
          agUiModal.style.display = 'none';
        }
      });

      let currentAgentExecution = null;
      let agUiCore = null;

      async function initializeAgUi() {
        try {
          agUiContainer.innerHTML = '<div style="color: #8be9fd; padding: 20px; text-align: center;">Loading agents...</div>';
          
          // Import @ag-ui/core protocol for event schemas
          if (!agUiCore) {
            agUiCore = await import('https://esm.sh/@ag-ui/core@latest');
            console.log('✅ @ag-ui/core loaded:', agUiCore);
          }
          
          // Fetch list of agents
          const response = await fetch('/api/files?path=agents');
          const data = await response.json();
          
          if (data.error) {
            throw new Error(data.error);
          }
          
          if (!data.entries) {
            throw new Error('Failed to load agents');
          }
          
          // Filter for directories only (agents)
          const agents = data.entries.filter(f => f.isDirectory && !f.name.startsWith('.'));
          
          if (agents.length === 0) {
            agUiContainer.innerHTML = `
              <div style="text-align: center; padding: 40px; color: #94a3b8;">
                <div style="font-size: 48px; margin-bottom: 16px;">🤖</div>
                <h3 style="color: #cbd5e1; margin-bottom: 8px;">No agents found</h3>
                <p style="font-size: 13px; margin-bottom: 20px;">Create an agent using the CLI to get started.</p>
                <code style="background: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 4px; font-size: 12px; display: inline-block;">deno task cli</code>
              </div>
            `;
            return;
          }
          
          // Display agent list
          agUiContainer.innerHTML = `
            <div style="color: #e2e8f0;">
              <div style="margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid rgba(148,163,184,0.15);">
                <p style="color: #94a3b8; font-size: 13px;">Select an agent to execute and monitor with AG-UI protocol</p>
              </div>
              <div id="agent-list" style="display: grid; gap: 12px;">
                ${agents.map(agent => `
                  <div class="agent-item" data-agent="${agent.name}" style="
                    background: rgba(15,23,42,0.65);
                    border: 1px solid rgba(148,163,184,0.12);
                    border-radius: 8px;
                    padding: 16px;
                    cursor: pointer;
                    transition: all 0.2s;
                  " onmouseover="this.style.background='rgba(56,189,248,0.1)'; this.style.borderColor='rgba(56,189,248,0.3)'" onmouseout="this.style.background='rgba(15,23,42,0.65)'; this.style.borderColor='rgba(148,163,184,0.12)'">
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <div style="font-size: 24px;">🤖</div>
                      <div style="flex: 1;">
                        <div style="font-weight: 600; color: #f8fafc; margin-bottom: 4px;">${agent.name}</div>
                        <div style="font-size: 12px; color: #94a3b8;">Click to execute with AG-UI monitoring</div>
                      </div>
                      <div style="color: #38bdf8; font-size: 20px;">▶</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
          
          // Add click handlers
          document.querySelectorAll('.agent-item').forEach(item => {
            item.addEventListener('click', () => {
              const agentName = item.dataset.agent;
              executeAgent(agentName);
            });
          });
          
          console.log('✅ Agent list loaded:', agents.length, 'agents');
          
        } catch (error) {
          agUiContainer.innerHTML = `
            <div style="color: #f87171; padding: 20px;">
              <h4 style="margin-bottom: 12px;">Failed to load agents</h4>
              <p style="color: #94a3b8; font-size: 13px; line-height: 1.6;">
                ${error.message}
              </p>
              <button onclick="initializeAgUi()" style="margin-top: 16px; background: #38bdf8; color: #0a0a0a; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Retry
              </button>
            </div>
          `;
          console.error('Agent list error:', error);
        }
      }

      async function executeAgent(agentName) {
        try {
          // Update UI to show execution state
          agUiContainer.innerHTML = `
            <div style="color: #e2e8f0; line-height: 1.6;">
              <div style="background: rgba(15,23,42,0.65); border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid rgba(148,163,184,0.12);">
                <h4 style="color: #38bdf8; margin-bottom: 12px; font-size: 16px;">🤖 Agent Overview</h4>
                <div style="font-size: 13px; color: #cbd5e1;">
                  <p><strong>Name:</strong> ${agentName}</p>
                  <p><strong>Status:</strong> <span style="color: #f1fa8c;" id="agent-status">Starting...</span></p>
                  <p><strong>Framework:</strong> Mastra + @ag-ui/core Protocol</p>
                </div>
              </div>

              <div style="background: rgba(15,23,42,0.65); border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid rgba(148,163,184,0.12);">
                <h4 style="color: #38bdf8; margin-bottom: 12px; font-size: 16px;">📊 Agent Output</h4>
                <div id="agent-output" style="font-size: 12px; color: #cbd5e1; font-family: monospace; background: rgba(0,0,0,0.5); padding: 12px; border-radius: 6px; max-height: 300px; overflow-y: auto;">
                  <p style="color: #8be9fd;">Executing agent...</p>
                </div>
              </div>

              <div style="background: rgba(15,23,42,0.65); border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid rgba(148,163,184,0.12);">
                <h4 style="color: #38bdf8; margin-bottom: 12px; font-size: 16px;">🔧 Tool Calls</h4>
                <div id="tool-calls-content" style="font-size: 13px; color: #cbd5e1;">
                  <p style="color: #94a3b8;">Monitoring tool usage...</p>
                </div>
              </div>

              <div style="display: flex; gap: 8px;">
                <button onclick="stopAgent()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                  ⏹ Stop
                </button>
                <button onclick="initializeAgUi()" style="background: rgba(148,163,184,0.2); color: #cbd5e1; border: 1px solid rgba(148,163,184,0.3); padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                  ← Back to List
                </button>
              </div>
            </div>
          `;
          
          // Execute the agent via WebSocket
          const command = `deno run --allow-read --allow-write --allow-env --allow-net --allow-sys agents/${agentName}/index.ts`;
          
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'run_command', command }));
            
            // Set up output capture
            setupAgentOutputCapture(agentName);
            
            console.log('▶ Executing agent:', agentName);
          } else {
            throw new Error('WebSocket not connected');
          }
          
        } catch (error) {
          agUiContainer.innerHTML = `
            <div style="color: #f87171; padding: 20px;">
              <h4 style="margin-bottom: 12px;">Failed to execute agent</h4>
              <p style="color: #94a3b8; font-size: 13px;">${error.message}</p>
              <button onclick="initializeAgUi()" style="margin-top: 16px; background: #38bdf8; color: #0a0a0a; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Back to List
              </button>
            </div>
          `;
        }
      }

      function setupAgentOutputCapture(agentName) {
        // Store original onmessage handler
        const originalHandler = ws.onmessage;
        
        // Create enhanced handler for agent output
        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            
            // Capture agent output
            if (data.type === 'output') {
              const outputEl = document.getElementById('agent-output');
              if (outputEl) {
                const line = document.createElement('div');
                line.textContent = data.data;
                line.style.whiteSpace = 'pre-wrap';
                line.style.marginBottom = '2px';
                outputEl.appendChild(line);
                outputEl.scrollTop = outputEl.scrollHeight;
              }
            }
            
            // Update status on process exit
            if (data.type === 'process_exit') {
              const statusEl = document.getElementById('agent-status');
              if (statusEl) {
                if (data.code === 0) {
                  statusEl.textContent = 'Completed ✓';
                  statusEl.style.color = '#50fa7b';
                } else {
                  statusEl.textContent = `Failed (code: ${data.code})`;
                  statusEl.style.color = '#ff5555';
                }
              }
            }
            
            // Call original handler
            if (originalHandler) {
              originalHandler.call(ws, event);
            }
          } catch (error) {
            console.error('Error processing agent output:', error);
          }
        };
        
        currentAgentExecution = agentName;
      }

      function stopAgent() {
        if (ws && ws.readyState === WebSocket.OPEN) {
          // Send Ctrl+C signal
          ws.send(JSON.stringify({ type: 'input', data: '\x03' }));
          
          const statusEl = document.getElementById('agent-status');
          if (statusEl) {
            statusEl.textContent = 'Stopped';
            statusEl.style.color = '#f1fa8c';
          }
        }
      }

      // Make functions globally accessible
      window.initializeAgUi = initializeAgUi;
      window.executeAgent = executeAgent;
      window.stopAgent = stopAgent;

      // Initialize
      console.log('🏭 ERA Web UI Loading...');
      connectWebSocket();
      loadFiles();
    </script>
  </body>
</html>
